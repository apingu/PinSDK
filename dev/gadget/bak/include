//
//
//
//
//
//
//
//
//
//
//
//
//
//
//
#pragma once

#pragma warning(disable:4786)

#include <map>
#include <vector>
#include <PfDef.h>

typedef unsigned short         funcchannelid_t;

namespace PfGet  // Pf gadget
{
#define _MESSAGE_CHANNEL_NOT_FIND -99

    const unsigned int _MAX_MESSAGE_CHANNEL = 0XFFFF;
    const unsigned int _MAX_CHANNEL_DIVIDE  = 1000;
    
    typedef __SLAPI int( *const ChannelFunction )( const void* argu, const ubyte_t* combin, unsigned int comlen );
    //typedef __SLAPI void* ChannelFunction;
    
    
    class MessageDispatcher
    {
        typedef std::map<funcchannelid_t, ChannelFunction> ChannelMap;
        
        unsigned int m_MaxChannels;
        ChannelMap   m_Channels[_MAX_CHANNEL_DIVIDE];
        
    public:
    
        MessageDispatcher();
        virtual ~MessageDispatcher();
        
        void           SetMaxChannel( _IN unsigned int size );
        unsigned int   GetMaxChannel( void );
        
        /**
         è¨»å†Šä¸€å€‹callbackå‡½å¼ã€‚
         @param cid ä½¿ç”¨çš„channelè™Ÿç¢¼ã€‚æœ€å¤§å€¼ç‚º65535ã€‚
         @param func è¦è¨»å†Šçš„å‡½å¼æŒ‡æ¨™ã€‚
         */
        bool            RegisterChannel( _IN funcchannelid_t chid, _IN ChannelFunction func );
        bool            UnRegisterChannel( _IN funcchannelid_t chid );
        
        ChannelFunction GetFunction( _IN funcchannelid_t chid );
        int             DispatchMessage( _IN const void* argu, _IN funcchannelid_t chid, _IN const ubyte_t* combin, _IN unsigned int comlen );
        
        void            GetAllChannelId( _OUT std::vector<funcchannelid_t>& channellist );
    };
    
};//
// ï¿½pï¿½ï¿½ï¿½ï¿½ Record dictionary
//
//
//
//
//
//
//
//
#pragma once

#include <PfDef.h>
#include <template\vmapl.inl>

namespace PfGet
{
    class Recdit
    {

        PfStl::vmapl<std::map<_tstring, _tstring>>    m_RecordPool;    // ï¿½Ò¦ï¿½key value ï¿½Èªï¿½ï¿½eï¿½ï¿½

    public:

        Recdit();
        ~Recdit();

        void                Init( int max_vec = 100 );

        // ï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½J ï¿½sï¿½b ï¿½Nï¿½Ø¥ß·sï¿½ï¿½ ï¿½iï¿½Hï¿½sï¿½ï¿½ï¿½ï¿½ï¿½í¼†-1 ï¿½Ã»ï¿½ï¿½sï¿½ï¿½
        void                Set( _IN _tstring key, _IN _tstring val, stimen_t timeout = -1 );
        // ï¿½ï¿½ï¿½sï¿½bï¿½~ï¿½[ï¿½J ï¿½Ã¦^ï¿½Ç true ï¿½sï¿½b ï¿½Nï¿½ï¿½ï¿½[ï¿½J ï¿½Ã¦^ï¿½Ç false ï¿½iï¿½Hï¿½sï¿½ï¿½ï¿½ï¿½ï¿½í¼†-1 ï¿½Ã»ï¿½ï¿½sï¿½ï¿½
        bool                Setnx( _IN _tstring key, _IN _tstring val, stimen_t timeout = -1 );
        _tstring            Get( _IN _tstring key );
        void                Del( _IN _tstring key );

        void                HSet( _IN _tstring key, _IN _tstring fld, _IN _tstring val );
        bool                HSetnx( _IN _tstring key, _IN _tstring fld, _IN _tstring val );
        _tstring            HGet( _IN _tstring key, _IN _tstring fld );
        void                HDel( _IN _tstring key, _IN _tstring fld );

    private:
        static void         DoUpdate( void* data );
    };
}